---
title: Test
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center')
library(kableExtra)
library(ggpubr)
library(scales)
library(plotly)
library(tidyverse)

c.theme <- function(){
  theme_minimal() +
    theme(text = element_text(family = 'Times New Roman'),
          plot.title = element_text(hjust = 0.5, size = 20),
          axis.title = element_text(size = 14),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 14))
}
```

```{r setup fonts, include = FALSE}
library(extrafont)

loadfonts(device = 'win')
```


## General Tracking Information

```{r, include = FALSE}
perc_tracked_block <- combined_n %>%
  filter(block != 'instructions') %>%
  mutate(block = fct_drop(block)) %>%
  group_by(trials_this_n, block) %>%
  summarize(n = n(),
            perc = round(sum(!is.na(average_gaze_x) & !is.na(average_gaze_y))/n()*100,2)) %>%
  ungroup() %>%
  complete(trials_this_n,block)

perc_tracked_overall <- combined_n %>%
  filter(block != 'instructions') %>%
  summarize(perc = round(sum(!is.na(average_gaze_x) & !is.na(average_gaze_y))/n()*100,2),
            n = n())

missing_blocks <- perc_tracked_block %>%
  filter(is.na(perc))
```

Overall, `r perc_tracked_overall$perc`% of samples had a recorded gaze position.

The total number of blocks in this design was `r nlevels(perc_tracked_block$trials_this_n) * nlevels(perc_tracked_block$block)`. This was calculated as the number of trials multiplied by the number of blocks within each trial.

Out of those blocks, `r nrow(missing_blocks)` were completely missing data. These missing blocks can be seen below:

<center>

```{r print missing blocks}
missing_blocks %>%
  kable %>%
  kable_styling("striped") %>% 
  scroll_box(width = "500px", height = "100px")
```

</center>


The percent of samples tracked within each block can be seen below:

<center>

```{r print percent tracked}
perc_tracked_block %>%
  kable %>%
  kable_styling("striped") %>% 
 scroll_box(width = "500px", height = "200px")
```

</center>

### Gaze Position

```{r}
perc_on_screen <- combined_n %>%
  filter(block != 'instructions', !is.na(average_gaze_x),!is.na(average_gaze_y)) %>%
  summarize(avg_within = round(sum(between(average_gaze_x,0,1920) & between(average_gaze_y,0,1080))/n()*100,2))

perc_in_stim <- combined_n %>%
  filter(block == 'stimulus', !is.na(average_gaze_x), !is.na(average_gaze_y)) %>%
  summarize(avg_within = round(sum(between(average_gaze_x,540,1380) & between(average_gaze_y,270,810))/n()*100,2))
```

All gaze position data is taken after the instructions were completed. Presented data is average gaze position as given by the eyetracker. Samples where no eyetracking data is recorded are removed from the overall count.

- % of time participant was gazing on screen: `r perc_on_screen$avg_within`%.

<center>

```{r screen gaze position}
screen_gaze_hist <- combined_n %>%
  filter(block != 'instructions', between(average_gaze_x,0,1920) & between(average_gaze_y,0,1080)) %>%
  select(average_gaze_x, average_gaze_y) %>%
  ggplot(aes(x = average_gaze_x, average_gaze_y, fill = ..count../sum(..count..)*100,
             text = after_stat(paste('x:', round(x,0), '\n',
                                     'y:', round(-y,0), '\n',
                                     'percent:', round(count/sum(count)*100,2),'%')))) +
  geom_hex() +
  scale_y_reverse() +
  scale_fill_viridis_c(option = 'inferno', limits = c(0,15), oob = squish) +
  coord_fixed() +
  labs(title = 'Gaze Plot Over the Screen', x = '', y = '', fill = '% of samples') +
  c.theme()

ggplotly(screen_gaze_hist, tooltip = 'text')
```

</center>

- % of time participant was gazing within the stimulus area during stimulus blocks: `r perc_in_stim$avg_within`%.

<center>

```{r stim gaze position}
stim_gaze_hist <- combined_n %>%
  filter(block != 'instructions', between(average_gaze_x,540,1380) & between(average_gaze_y,270,810)) %>%
  select(average_gaze_x, average_gaze_y) %>%
  ggplot(aes(x = average_gaze_x, y = average_gaze_y, fill = ..count../sum(..count..)*100,
             text = after_stat(paste('x:', round(x,0), '\n',
                                     'y:', round(-y,0), '\n',
                                     'percent:', round(count/sum(count)*100,2),'%')))) +
  geom_hex() +
  scale_y_reverse() +
  coord_fixed() + 
  scale_fill_viridis_c(option = 'inferno', limits = c(0,6), oob = squish) +
  labs(title = 'Gaze Within Stimulus Zone during Stimulus', x = '', y = '', fill = '% of samples') +
  c.theme()

ggplotly(stim_gaze_hist, tooltip = list('x','y','text'))
```

</center>

## Pupil Size

### Distribution of Pupil Sizes

Eyelink reports pupil data from left and right eyes as well as the average of the two. The preprocessing pipeline performs mean and median normalization on all 3 measures relative to prefixation and fixation baselines. The following plots show the distribution of pupil sizes for samples where the participant has their gaze on the screen during the experiment (i.e. past the instructions block).

```{r pupil size histograms}
pupil_dens <- function(df,plot_title){
  df %>%
    pivot_longer(everything(),
                 names_to = 'type',
                 values_to = 'size') %>%
    mutate(type = str_extract(type,c('average','left','right'))) %>%
    ggplot(aes(x = size, fill = type)) +
    geom_density(alpha = .3) +
    labs(x = 'Pupil Size', y = '', title = plot_title, fill = 'Eye') +
    c.theme() +
    theme(plot.title = element_text(size = 14),
          axis.title = element_text(size = 12))
}

raw_p <- combined_n %>%
  filter(block != 'instructions', between(average_gaze_x,0,1920), between(average_gaze_y,0,1080)) %>%
  select(c(average_pupil_size,left_pupil_size,right_pupil_size)) %>%
  pupil_dens(plot_title = 'Raw Pupil Size')

med_pf_p <- combined_n %>%
  filter(block != 'instructions', between(average_gaze_x,0,1920), between(average_gaze_y,0,1080)) %>%
  select(c(med_average_pupil_norm_pf, med_left_pupil_norm_pf, med_right_pupil_norm_pf)) %>%
  pupil_dens(plot_title = 'Median Prefix Normalized Pupil Size')

med_fix_p <- combined_n %>%
  filter(block != 'instructions', between(average_gaze_x,0,1920), between(average_gaze_y,0,1080)) %>%
  select(c(mean_average_pupil_norm_pf, mean_left_pupil_norm_pf, mean_right_pupil_norm_pf)) %>%
  pupil_dens(plot_title = 'Mean Prefix Normalized Pupil Size')

mean_pf_p <- combined_n %>%
  filter(block != 'instructions', between(average_gaze_x,0,1920), between(average_gaze_y,0,1080)) %>%
  select(c(med_average_pupil_norm_fix, med_left_pupil_norm_fix, med_right_pupil_norm_fix)) %>%
  pupil_dens(plot_title = 'Median Fixation Normalized Pupil Size')

mean_fix_p <- combined_n %>%
  filter(block != 'instructions', between(average_gaze_x,0,1920), between(average_gaze_y,0,1080)) %>%
  select(c(mean_average_pupil_norm_fix, mean_left_pupil_norm_fix, mean_right_pupil_norm_fix)) %>%
  pupil_dens(plot_title = 'Mean Fixation Normalized Pupil Size')

fix_plots <- ggarrange(med_pf_p, med_fix_p, mean_pf_p, mean_fix_p, raw_p, 
                       ncol = 2,
                       nrow = 3,
                       common.legend = TRUE)

ggplotly(fix_plots)
```

### Pupil Sizes During Stimuli

#### Epoch Median

Median pupil size is plotted for each stimulus as a function of epoch.

```{r raw stimuli pupil sizes}
stim_df %>%
  ggplot(aes(x = epoch, y = stim_med_average_pupil_size))
```

